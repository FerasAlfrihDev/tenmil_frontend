// ========================================
// API TABLE STYLES
// ========================================

@use 'sass:color';
@use '../../../styles/abstracts/variables' as *;
@use '../../../styles/abstracts/mixins' as *;

// Import component styles
@use './components/TableFilters.scss';
@use './components/TablePagination.scss';
@use './components/TableToolbar.scss';
@use './components/TableActions.scss';

// ========================================
// Main Container
// ========================================

.api-table {
  display: flex;
  flex-direction: column;
  width: 100%;
  height: 100%;
  background: var(--card-bg, $light-background);
  border: 1px solid var(--border-color, $border-primary);
  @include viewport-spacing(padding, $space-sm, horizontal);
  border-radius: $border-radius;
  overflow: hidden;

  // Theme support
  .theme-light &,
  :root:not(.theme-dark) & {
    --card-bg: #{$light-background};
    --card-text: #{$light-text};
    --border-color: #{$light-border};
  }

  .theme-dark & {
    --card-bg: #{$dark-background};
    --card-text: #{$dark-text};
    --border-color: #{$dark-border};
  }

  @media (prefers-color-scheme: dark) {
    :root:not(.theme-light) & {
      --card-bg: #{$dark-background};
      --card-text: #{$dark-text};
      --border-color: #{$dark-border};
    }
  }

  // Size variants
  &--small {
    @include viewport-font-size($font-size-sm);
  }

  &--middle {
    @include viewport-font-size($font-size-base);
  }

  &--large {
    @include viewport-font-size($font-size-md);
  }

  // Density variants
  &--compact {
    .table-header__cell,
    .table-body__cell {
      @include viewport-spacing(padding, $space-xs $space-sm);
    }
  }

  &--comfortable {
    .table-header__cell,
    .table-body__cell {
      @include viewport-spacing(padding, $space-md $space-xs);
    }
  }

  // Style variants
  &--bordered {
    .table-header__cell,
    .table-body__cell {
      border-right: 1px solid var(--border-color, $border-primary);

      &:last-child {
        border-right: none;
      }
    }
  }

  &--striped {
    .table-body__row:nth-child(even) {
      background: rgba(var(--card-bg-rgb, 255, 255, 255), 0.5);
    }
  }

  &--hover {
    .table-body__row {
      transition: background-color $transition-speed ease;

      &:hover {
        background: rgba(var(--primary-color-rgb, 27, 36, 70), 0.05);
      }
    }
  }

  // Loading state
  &--loading {
    pointer-events: none;
    opacity: 0.7;
  }

  // Error state
  &--error {
    border-color: var(--error-color, $error-color);
  }

}

// ========================================
// Error Display
// ========================================

.api-table__error {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--error-light, $error-light);
  color: var(--error-color, $error-color);
  border: 1px solid var(--error-color, $error-color);
  border-radius: $border-radius-sm;
  @include viewport-spacing(padding, $space-sm $space-base);
  @include viewport-spacing(margin, $space-base);

  &-text {
    @include viewport-font-size($font-size-sm);
    font-weight: $font-weight-medium;
  }

  &-retry {
    background: var(--error-color, $error-color);
    color: white;
    border: none;
    border-radius: $border-radius-sm;
    @include viewport-spacing(padding, $space-xs $space-sm);
    @include viewport-font-size($font-size-sm);
    cursor: pointer;
    transition: opacity $transition-speed ease;

    &:hover {
      opacity: 0.9;
    }
  }
}

.api-table__export-error {
  background: var(--warning-light, $warning-light);
  color: var(--warning-color, $warning-color);
  border: 1px solid var(--warning-color, $warning-color);
  border-radius: $border-radius-sm;
  @include viewport-spacing(padding, $space-sm $space-base);
  @include viewport-spacing(margin, $space-base);

  &-text {
    @include viewport-font-size($font-size-sm);
    font-weight: $font-weight-medium;
  }
}

// ========================================
// Table Container
// ========================================

.api-table__container {
  overflow: auto;
  flex: 1;
  min-height: 0; // Allow flex item to shrink below content size
  
  &::-webkit-scrollbar {
    width: to-fixed-pixels(0.5vmin);
    height: to-fixed-pixels(0.5vmin);
  }

  &::-webkit-scrollbar-track {
    background: var(--surface-color, $surface-primary);
  }

  &::-webkit-scrollbar-thumb {
    background: var(--border-color, $border-primary);
    border-radius: $border-radius-sm;

    &:hover {
      background: rgba(var(--border-color-rgb, 229, 231, 235), 0.8);
    }
  }
}

.api-table__table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

// ========================================
// Table Header
// ========================================

.table-header {
  background: var(--header-bg, $header-background);
  color: var(--header-text, $header-text-color);
  
  // Theme support for header - always use light text on dark header
  .theme-light &,
  :root:not(.theme-dark) & {
    --header-bg: #{$header-background}; // Dark blue background
    --header-text: #{$dark-text}; // Light text (same as dark mode)
    --header-bg-rgb: 27, 36, 70; // RGB values for rgba usage
  }

  .theme-dark & {
    --header-bg: #{$header-background}; // Dark blue background  
    --header-text: #{$dark-text}; // Light text
    --header-bg-rgb: 27, 36, 70; // RGB values for rgba usage
  }

  @media (prefers-color-scheme: dark) {
    :root:not(.theme-light) & {
      --header-bg: #{$header-background}; // Dark blue background
      --header-text: #{$dark-text}; // Light text
      --header-bg-rgb: 27, 36, 70; // RGB values for rgba usage
    }
  }

  &--sticky {
    position: sticky;
    top: 0;
    z-index: $z-index-header;
  }

  &__row {
    border-bottom: 2px solid var(--border-color, $border-primary);
    
    // Force header text color to override global styles
    color: var(--header-text, $header-text-color) !important;
    
    * {
      color: var(--header-text, $header-text-color) !important;
    }
  }

  &__cell {
    @include viewport-spacing(padding, $space-sm $space-base);
    @include viewport-font-size($font-size-base);
    font-weight: $font-weight-semibold;
    text-align: left;
    vertical-align: middle;
    border-bottom: 1px solid var(--border-color, $border-primary);
    background: inherit;
    position: relative;
    
    // Force header text color to override global styles
    color: var(--header-text, $header-text-color) !important;
    
    // Override any nested elements
    *, div, span, p, h1, h2, h3, h4, h5, h6 {
      color: var(--header-text, $header-text-color) !important;
    }

    &--selection {
      width: 40px;
      @include viewport-spacing(padding, $space-xs $space-sm);
    }

    &--sortable {
      cursor: pointer;
      user-select: none;

      &:hover {
        background: rgba(var(--header-bg-rgb, 248, 249, 250), 0.8);
      }
    }

    &--left {
      text-align: left;
    }

    &--center {
      text-align: center;
    }

    &--right {
      text-align: right;
    }

    &--fixed-left {
      position: sticky;
      left: 0;
      z-index: $z-index-sidebar;
    }

    &--fixed-right {
      position: sticky;
      right: 0;
      z-index: $z-index-sidebar;
    }
  }

  &__content {
    display: flex;
    flex-direction: column;
    @include viewport-spacing(gap, $space-xs);
  }

  &__title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    @include viewport-spacing(gap, $space-xs);
    width: 100%;
  }

  &__title {
    display: flex;
    align-items: center;
    @include viewport-spacing(gap, $space-xs);
    flex: 1;

    &--sortable {
      cursor: pointer;
    }
  }

  &__search {
    position: relative;
    display: flex;
    align-items: center;
  }

  &__search-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    @include viewport-spacing(padding, $space-xs);
    background: none;
    border: 1px solid transparent;
    border-radius: $border-radius-sm;
    color: var(--text-muted, $text-muted);
    cursor: pointer;
    transition: all $transition-speed ease;

    &:hover {
      background: rgba(var(--primary-color-rgb, 27, 36, 70), 0.1);
      color: var(--primary-color, $primary-color);
      border-color: var(--primary-color, $primary-color);
    }

    &--active {
      background: var(--primary-color, $primary-color);
      color: white;
      border-color: var(--primary-color, $primary-color);
    }
  }

  &__search-popup {
    position: absolute;
    top: 100%;
    right: 0;
    @include viewport-spacing(margin-top, $space-xs);
    background: var(--card-bg, $light-background);
    border: 1px solid var(--border-color, $border-primary);
    border-radius: $border-radius-sm;
    box-shadow: $box-shadow-base;
    z-index: $z-index-overlay;
    min-width: 200px;
    display: flex;
    align-items: center;
    @include viewport-spacing(padding, $space-xs);
    @include viewport-spacing(gap, $space-xs);
  }

  &__search-input {
    flex: 1;
    @include viewport-spacing(padding, $space-xs);
    border: 1px solid var(--input-border, $border-primary);
    border-radius: $border-radius-sm;
    background: var(--input-bg, $light-background);
    color: var(--input-text, $text-primary);
    @include viewport-font-size($font-size-sm);
    outline: none;
    transition: border-color $transition-speed ease;

    &:focus {
      border-color: var(--primary-color, $primary-color);
    }

    &::placeholder {
      color: var(--text-muted, $text-muted);
    }
  }

  &__search-clear {
    display: flex;
    align-items: center;
    justify-content: center;
    @include viewport-spacing(padding, $space-xs);
    background: none;
    border: none;
    border-radius: $border-radius-sm;
    color: var(--text-muted, $text-muted);
    cursor: pointer;
    transition: all $transition-speed ease;

    &:hover {
      background: rgba(var(--error-color-rgb, 239, 68, 68), 0.1);
      color: var(--error-color, $error-color);
    }
  }

  &__text {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  &__sort-icon {
    opacity: 0.6;
    transition: opacity $transition-speed ease;

    &--active {
      opacity: 1;
      color: var(--primary-color, $primary-color);
    }
  }

  &__resize-handle {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 8px;
    cursor: col-resize;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity $transition-speed ease;

    &:hover {
      opacity: 1;
      background: rgba(var(--primary-color-rgb, 27, 36, 70), 0.1);
    }
  }

  &__cell:hover &__resize-handle {
    opacity: 0.6;
  }
}

// ========================================
// Table Body
// ========================================

.table-body {
  background: var(--table-body-bg, $light-background);
  
  // Theme support for table body background
  .theme-light &,
  :root:not(.theme-dark) & {
    --table-body-bg: #EFEFEF; // Darker shade than main light background (#F5F5F5)
  }

  .theme-dark & {
    --table-body-bg: #{$dark-surface}; // Same as toolbar background
  }

  @media (prefers-color-scheme: dark) {
    :root:not(.theme-light) & {
      --table-body-bg: #{$dark-surface}; // Same as toolbar background
    }
  }

  &__row {
    border-bottom: 1px solid var(--border-color, $border-primary);
    transition: background-color $transition-speed ease;

    &--clickable {
      cursor: pointer;
    }

    &--selected {
      background: rgba(var(--selected-color-rgb, 34, 197, 94), 0.1);
    }

    &--expanded {
      background: rgba(var(--primary-color-rgb, 27, 36, 70), 0.05);
    }

    &--loading {
      pointer-events: none;
    }

    &--empty {
      &:hover {
        background: transparent !important;
      }
    }

    &--expanded-content {
      background: rgba(var(--primary-color-rgb, 27, 36, 70), 0.02);

      &:hover {
        background: rgba(var(--primary-color-rgb, 27, 36, 70), 0.02) !important;
      }
    }
  }

  &__cell {
    @include viewport-spacing(padding, $space-base);
    @include viewport-font-size($font-size-base);
    color: var(--card-text, $text-primary);
    vertical-align: middle;
    border-bottom: inherit;

    &--selection {
      width: 40px;
      @include viewport-spacing(padding, $space-sm);
    }

    &--expand {
      width: 40px;
      @include viewport-spacing(padding, $space-sm);
    }

    &--left {
      text-align: left;
    }

    &--center {
      text-align: center;
    }

    &--right {
      text-align: right;
    }

    &--fixed-left {
      position: sticky;
      left: 0;
      z-index: $z-index-sidebar;
      background: inherit;
    }

    &--fixed-right {
      position: sticky;
      right: 0;
      z-index: $z-index-sidebar;
      background: inherit;
    }

    &--empty {
      text-align: center;
      @include viewport-spacing(padding, $space-xxl);
      color: var(--text-muted, $text-muted);
    }

    &--expanded-content {
      @include viewport-spacing(padding, 0);
    }
  }

  &__content {
    &--ellipsis {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }

  &__expand-btn {
    background: none;
    border: none;
    cursor: pointer;
    @include viewport-spacing(padding, $space-xs);
    border-radius: $border-radius-sm;
    color: var(--card-text, $text-primary);
    transition: background-color $transition-speed ease;

    &:hover {
      background: rgba(var(--primary-color-rgb, 27, 36, 70), 0.1);
    }
  }

  &__expanded-content {
    @include viewport-spacing(padding, $space-base);
    border-top: 1px solid var(--border-color, $border-primary);
    background: var(--surface-color, $surface-primary);
  }

  &__empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    @include viewport-spacing(gap, $space-base);

    &-text {
      @include viewport-font-size($font-size-base);
      color: var(--text-muted, $text-muted);
    }
  }

  &__skeleton {
    background: linear-gradient(90deg, 
      rgba(var(--border-color-rgb, 229, 231, 235), 0.1) 25%, 
      rgba(var(--border-color-rgb, 229, 231, 235), 0.2) 50%, 
      rgba(var(--border-color-rgb, 229, 231, 235), 0.1) 75%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: $border-radius-sm;
    height: to-fixed-pixels(1.2vmin);

    &--checkbox {
      width: to-fixed-pixels(1.2vmin);
      height: to-fixed-pixels(1.2vmin);
    }

    &--expand {
      width: to-fixed-pixels(1vmin);
      height: to-fixed-pixels(1vmin);
    }
  }
}

@keyframes skeleton-loading {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

// ========================================
// Summary
// ========================================

.api-table__summary {
  @include viewport-spacing(padding, $space-base);
  border-top: 1px solid var(--border-color, $border-primary);
  background: var(--surface-color, $surface-primary);
  @include viewport-font-size($font-size-sm);
  color: var(--text-secondary, $text-secondary);
}

// ========================================
// Responsive Design
// ========================================

@media (max-width: 768px) {
  .api-table {
    &__container {
      overflow-x: auto;
    }

    .table-header__cell,
    .table-body__cell {
      min-width: to-fixed-pixels(8vmin);
      white-space: nowrap;
    }
  }
}

// Viewport spacing utility classes are included via utilities/_spacing.scss
